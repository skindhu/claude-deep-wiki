"""
Structure Prompt Builder - ç»“æ„æ‰«ææç¤ºè¯æ„å»ºå™¨

è´Ÿè´£æ„å»ºæ‰€æœ‰ä¸ç»“æ„æ‰«æç›¸å…³çš„æç¤ºè¯
"""

import json
from typing import Dict, Any, List


class StructurePromptBuilder:
    """ç»“æ„æ‰«æçš„æç¤ºè¯æ„å»ºå™¨"""

    @staticmethod
    def build_scan_and_identify_prompt(repo_path: str) -> str:
        """
        æ„å»ºé˜¶æ®µ1çš„æç¤ºè¯ï¼šç»“æ„æ‰«æä¸æ¨¡å—è¯†åˆ«

        Args:
            repo_path: ä»“åº“æ ¹ç›®å½•è·¯å¾„

        Returns:
            æç¤ºè¯å­—ç¬¦ä¸²
        """
        return f"""ä½ æ˜¯ä»£ç ä»“åº“ç»“æ„åˆ†æä¸“å®¶ã€‚è¿™æ˜¯**é˜¶æ®µ1ï¼šç»“æ„æ‰«æä¸æ¨¡å—è¯†åˆ«**ã€‚

ä»“åº“è·¯å¾„: {repo_path}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“‹ é˜¶æ®µ1 ä»»åŠ¡ï¼šç»“æ„æ‰«æä¸æ¨¡å—è¯†åˆ«
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

æ­¥éª¤1: æ‰«æä»“åº“ç»“æ„
- **å¿…é¡»**ä½¿ç”¨ scan_repository_structure å·¥å…·æ‰«æä»“åº“ï¼ˆä»…è°ƒç”¨1æ¬¡ï¼‰
- äº†è§£ç›®å½•ç»“æ„ã€æ–‡ä»¶åˆ†å¸ƒã€è¯­è¨€ç»Ÿè®¡

æ­¥éª¤2: è¯†åˆ«ä¸šåŠ¡åŠŸèƒ½æ¨¡å—
- åŸºäºç›®å½•ç»“æ„å’Œæ–‡ä»¶å‘½åè¯†åˆ«æ‰€æœ‰ä¸šåŠ¡åŠŸèƒ½æ¨¡å—
- æ„å»ºå¤šçº§æ¨¡å—å±‚æ¬¡ç»“æ„ï¼ˆä¸€çº§ã€äºŒçº§ã€å¯é€‰ä¸‰çº§ï¼‰
- ä¸ºæ¯ä¸ªä¸€çº§æ¨¡å—æä¾›ç®€çŸ­èŒè´£æè¿°ï¼ˆ1-2å¥è¯ï¼‰
  * åŸºäºç›®å½•åã€æ–‡ä»¶åæ¨æ–­
  * ä¸è¦æ·±å…¥åˆ†æä»£ç å®ç°

æ­¥éª¤3: é€‰æ‹©å…³é”®æ–‡ä»¶è·¯å¾„
- ä¸ºæ¯ä¸ªä¸€çº§æ¨¡å—é€‰æ‹© 5-10 ä¸ªæœ€å…³é”®çš„æ–‡ä»¶**è·¯å¾„**
- ä¼˜å…ˆé€‰æ‹©ï¼šå…¥å£æ–‡ä»¶ã€ç®¡ç†ç±»ã€ä¸»è¦ä¸šåŠ¡é€»è¾‘æ–‡ä»¶
- é€‰æ‹©æ ‡å‡†ï¼šæ–‡ä»¶åç‰¹å¾ï¼ˆå¦‚ index/main/manager/controllerï¼‰ã€ç›®å½•ä½ç½®
- **æ³¨æ„**ï¼šè¿™ä¸€é˜¶æ®µåªé€‰æ‹©è·¯å¾„ï¼Œä¸åˆ†ææ–‡ä»¶å†…å®¹

æ­¥éª¤4: åˆæ­¥åˆ†å±‚åˆ¤æ–­
- ä¸ºæ¯ä¸ªæ¨¡å—åˆæ­¥åˆ¤æ–­å…¶å±‚æ¬¡ï¼ˆcore/business/utilsï¼‰
- åˆ†å±‚æ ‡å‡†ï¼ˆåŸºäºç›®å½•ç»“æ„å’Œå‘½åï¼‰ï¼š
  * core: çœ‹èµ·æ¥æ˜¯åŸºç¡€/é€šç”¨æ¨¡å—ï¼ˆå¦‚ common/core/baseï¼‰
  * business: çœ‹èµ·æ¥æ˜¯ä¸šåŠ¡æ¨¡å—ï¼ˆå¦‚ user/order/productï¼‰
  * utils: çœ‹èµ·æ¥æ˜¯å·¥å…·æ¨¡å—ï¼ˆå¦‚ helpers/tools/utilsï¼‰
- **æ³¨æ„**ï¼šè¿™åªæ˜¯åˆæ­¥åˆ¤æ–­ï¼Œç²¾ç¡®åˆ†å±‚åœ¨é˜¶æ®µ3

æ­¥éª¤5: åˆ—å‡ºæ‰€æœ‰æ–‡ä»¶
- ä¸ºæ¯ä¸ªæ¨¡å—åˆ—å‡ºæ‰€æœ‰ç›¸å…³æ–‡ä»¶è·¯å¾„ï¼ˆå®Œæ•´åˆ—è¡¨ï¼‰

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
âš ï¸ é˜¶æ®µ1 çº¦æŸ
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

1. å·¥å…·è°ƒç”¨ï¼š
   - âœ… ä½¿ç”¨ scan_repository_structureï¼ˆ1æ¬¡ï¼‰
   - âŒ ä¸è¦ä½¿ç”¨ extract_imports_and_exportsï¼ˆç•™ç»™é˜¶æ®µ2ï¼‰
   - âŒ ä¸è¦ä½¿ç”¨ build_dependency_graphï¼ˆç•™ç»™é˜¶æ®µ3ï¼‰

2. èŒè´£è¾¹ç•Œï¼š
   - âœ… è¯†åˆ«æ¨¡å—ç»“æ„
   - âœ… é€‰æ‹©å…³é”®æ–‡ä»¶è·¯å¾„
   - âœ… åˆæ­¥åˆ†å±‚åˆ¤æ–­
   - âŒ ä¸è¦åˆ†ææ–‡ä»¶ä¾èµ–
   - âŒ ä¸è¦æ„å»ºä¾èµ–å›¾

3. æè¿°é£æ ¼ï¼š
   - èŒè´£æè¿°ä¿æŒç®€çŸ­ï¼ˆ1-2å¥è¯ï¼‰
   - ä¾‹å¦‚ï¼š"ç”¨æˆ·è®¤è¯æ¨¡å—ï¼Œè´Ÿè´£ç™»å½•æ³¨å†Œå’Œæƒé™ç®¡ç†"

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“¤ è¾“å‡ºæ ¼å¼ï¼ˆå¿…é¡»æ˜¯å®Œæ•´çš„ JSONï¼‰
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

å®Œæˆåˆ†æåï¼Œ**ç«‹å³è¾“å‡ºä¸€ä¸ªå®Œæ•´çš„ JSON ä»£ç å—**ï¼ˆç”¨ ```json åŒ…è£¹ï¼‰ï¼š

```json
{{
  "project_info": {{
    "name": "é¡¹ç›®åç§°",
    "primary_language": "ä¸»è¦ç¼–ç¨‹è¯­è¨€",
    "total_files": æ–‡ä»¶æ€»æ•°
  }},
  "modules": [
    {{
      "name": "ä¸€çº§æ¨¡å—åç§°",
      "layer_guess": "core/business/utils",
      "layer_reason": "åˆæ­¥åˆ¤æ–­ä¾æ®",
      "responsibility": "æ¨¡å—ç®€çŸ­èŒè´£æè¿°ï¼ˆ1-2å¥è¯ï¼‰",
      "sub_modules": [
        {{
          "name": "äºŒçº§æ¨¡å—åç§°",
          "description": "ç®€çŸ­æè¿°"
        }}
      ],
      "all_files": [
        "src/module/file1.js",
        "src/module/file2.js"
      ],
      "key_files_paths": [
        "src/module/main.js",
        "src/module/controller.js"
      ]
    }}
  ]
}}
```

**é‡è¦æç¤º**:
- è¾“å‡ºå¿…é¡»æ˜¯æœ‰æ•ˆçš„ JSON
- ä¸è¦åœ¨ JSON å‰åæ·»åŠ è¯´æ˜æ–‡å­—
- ç¡®ä¿æ‰€æœ‰å­—æ®µéƒ½æœ‰å€¼ï¼ˆå¦‚æœæŸä¸ªæ¨¡å—æ²¡æœ‰å­æ¨¡å—ï¼Œsub_modules è®¾ä¸ºç©ºæ•°ç»„ []ï¼‰
"""

    @staticmethod
    def build_file_dependencies_prompt(
        repo_path: str,
        all_key_files: List[Dict[str, str]]
    ) -> str:
        """
        æ„å»ºé˜¶æ®µ2çš„æç¤ºè¯ï¼šä¾èµ–åˆ†æ

        Args:
            repo_path: ä»“åº“æ ¹ç›®å½•è·¯å¾„
            all_key_files: æ‰€æœ‰å…³é”®æ–‡ä»¶åˆ—è¡¨
                [
                    {"path": "src/module/file.js", "module": "æ¨¡å—å"},
                    ...
                ]

        Returns:
            æç¤ºè¯å­—ç¬¦ä¸²
        """
        total_files = len(all_key_files)
        files_json = json.dumps(all_key_files, ensure_ascii=False, indent=2)

        return f"""ä½ æ˜¯ä»£ç ä¾èµ–åˆ†æä¸“å®¶ã€‚è¿™æ˜¯**é˜¶æ®µ2ï¼šä¾èµ–åˆ†æ**ã€‚

ä»“åº“è·¯å¾„: {repo_path}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“‹ é˜¶æ®µ2 ä»»åŠ¡ï¼šåˆ†æå…³é”®æ–‡ä»¶ä¾èµ–
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ä½ éœ€è¦åˆ†æä»¥ä¸‹ {total_files} ä¸ªå…³é”®æ–‡ä»¶çš„å¯¼å…¥å¯¼å‡ºå…³ç³»ï¼š

{files_json}

ä»»åŠ¡æ­¥éª¤:
1. é€ä¸ªä½¿ç”¨ extract_imports_and_exports å·¥å…·åˆ†ææ¯ä¸ªæ–‡ä»¶
2. **é‡è¦**: æ–‡ä»¶è·¯å¾„æ˜¯ç›¸å¯¹è·¯å¾„æ—¶ï¼Œå¿…é¡»æä¾› repo_root="{repo_path}" å‚æ•°
3. æå–æ¯ä¸ªæ–‡ä»¶çš„ï¼š
   - imports: å¯¼å…¥äº†å“ªäº›æ¨¡å—/æ–‡ä»¶
   - exports: å¯¼å‡ºäº†ä»€ä¹ˆå†…å®¹
   - language: æ–‡ä»¶çš„ç¼–ç¨‹è¯­è¨€

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
âš ï¸ é˜¶æ®µ2 çº¦æŸ
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

1. å·¥å…·è°ƒç”¨ï¼š
   - âœ… ä½¿ç”¨ extract_imports_and_exportsï¼ˆé¢„ç®— {total_files} æ¬¡ï¼‰
   - âŒ ä¸è¦ä½¿ç”¨å…¶ä»–å·¥å…·

2. èŒè´£è¾¹ç•Œï¼š
   - âœ… æå–å¯¼å…¥å¯¼å‡ºä¿¡æ¯
   - âŒ ä¸è¦åˆ†ææ¨¡å—ä¾èµ–å…³ç³»ï¼ˆç•™ç»™é˜¶æ®µ3ï¼‰
   - âŒ ä¸è¦é‡æ–°åˆ¤æ–­æ¨¡å—åˆ†å±‚ï¼ˆç•™ç»™é˜¶æ®µ3ï¼‰

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“¤ è¾“å‡ºæ ¼å¼ï¼ˆå¿…é¡»æ˜¯å®Œæ•´çš„ JSONï¼‰
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

å®Œæˆåˆ†æåï¼Œ**ç«‹å³è¾“å‡ºä¸€ä¸ªå®Œæ•´çš„ JSON ä»£ç å—**ï¼ˆç”¨ ```json åŒ…è£¹ï¼‰ï¼š

```json
{{
  "file_dependencies": [
    {{
      "path": "src/module/main.js",
      "imports": ["vue", "./components/Header", "../utils/helper"],
      "exports": ["default", "init", "AppComponent"],
      "language": "javascript",
      "module": "æ¨¡å—å"
    }}
  ]
}}
```

**é‡è¦æç¤º**:
- å¦‚æœæŸä¸ªæ–‡ä»¶åˆ†æå¤±è´¥ï¼Œè·³è¿‡å®ƒï¼Œç»§ç»­åˆ†æä¸‹ä¸€ä¸ª
- è¾“å‡ºå¿…é¡»æ˜¯æœ‰æ•ˆçš„ JSON
- ä¸è¦åœ¨ JSON å‰åæ·»åŠ è¯´æ˜æ–‡å­—
"""

    @staticmethod
    def build_finalize_structure_prompt(
        structure_overview: Dict[str, Any],
        dependencies: Dict[str, Any]
    ) -> str:
        """
        æ„å»ºé˜¶æ®µ3çš„æç¤ºè¯ï¼šç»¼åˆåˆ†æä¸ç²¾ç¡®åˆ†å±‚

        Args:
            structure_overview: é˜¶æ®µ1çš„ç»“æ„æ¦‚è§ˆ
            dependencies: é˜¶æ®µ2çš„ä¾èµ–ä¿¡æ¯

        Returns:
            æç¤ºè¯å­—ç¬¦ä¸²
        """
        overview_json = json.dumps(structure_overview, ensure_ascii=False, indent=2)
        deps_json = json.dumps(dependencies, ensure_ascii=False, indent=2)
        file_deps = dependencies.get('file_dependencies', [])

        return f"""ä½ æ˜¯ä»£ç æ¶æ„åˆ†æä¸“å®¶ã€‚è¿™æ˜¯**é˜¶æ®µ3ï¼šç»¼åˆåˆ†æä¸ç²¾ç¡®åˆ†å±‚**ã€‚

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“‹ é˜¶æ®µ3 ä»»åŠ¡ï¼šæ•´åˆæ•°æ®å¹¶ç²¾ç¡®åˆ†å±‚
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ä½ æœ‰ä»¥ä¸‹æ•°æ®ï¼š

**1. æ¨¡å—ç»“æ„æ¦‚è§ˆ**:
{overview_json}

**2. æ–‡ä»¶ä¾èµ–ä¿¡æ¯**:
{deps_json}

ä»»åŠ¡æ­¥éª¤:
1. å°†æ–‡ä»¶ä¾èµ–ä¿¡æ¯æ•´åˆåˆ°å„æ¨¡å—çš„ key_files ä¸­
2. åŸºäºçœŸå®çš„å¯¼å…¥å¯¼å‡ºå…³ç³»ï¼Œåˆ†ææ¨¡å—é—´ä¾èµ–
3. æ„å»ºä¾èµ–å…³ç³»å›¾ï¼ˆä½¿ç”¨ build_dependency_graph å·¥å…·ï¼‰
4. åŸºäºä¾èµ–å…³ç³»ç²¾ç¡®åˆ¤æ–­æ¨¡å—åˆ†å±‚ï¼š
   - core: è¢«å¤šä¸ªæ¨¡å—ä¾èµ–çš„åŸºç¡€æ¨¡å—
   - business: ä¾èµ– core çš„ä¸šåŠ¡æ¨¡å—
   - utils: æä¾›å·¥å…·åŠŸèƒ½çš„æ¨¡å—
5. ç”Ÿæˆæ–‡ä»¶åˆ°æ¨¡å—çš„æ˜ å°„

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
âš ï¸ é˜¶æ®µ3 çº¦æŸ
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

1. å·¥å…·è°ƒç”¨ï¼š
   - âœ… å¯ä»¥ä½¿ç”¨ build_dependency_graphï¼ˆ1æ¬¡ï¼‰
   - âŒ ä¸è¦é‡æ–°åˆ†ææ–‡ä»¶

2. èŒè´£è¾¹ç•Œï¼š
   - âœ… æ•´åˆæ•°æ®
   - âœ… ç²¾ç¡®åˆ†å±‚
   - âœ… æ„å»ºä¾èµ–å›¾
   - âœ… ç”Ÿæˆæ˜ å°„

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“¤ è¾“å‡ºæ ¼å¼ï¼ˆå¿…é¡»æ˜¯å®Œæ•´çš„ JSONï¼‰
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

å®Œæˆåˆ†æåï¼Œ**ç«‹å³è¾“å‡ºä¸€ä¸ªå®Œæ•´çš„ JSON ä»£ç å—**ï¼ˆç”¨ ```json åŒ…è£¹ï¼‰ï¼š

```json
{{
  "project_info": {{
    "name": "é¡¹ç›®åç§°",
    "primary_language": "ä¸»è¦è¯­è¨€",
    "total_files": æ–‡ä»¶æ€»æ•°
  }},
  "module_hierarchy": {{
    "modules": [
      {{
        "name": "æ¨¡å—å",
        "layer": "core/business/utils",
        "layer_reason": "ç²¾ç¡®åˆ†å±‚åŸå› ï¼ˆåŸºäºä¾èµ–å…³ç³»ï¼‰",
        "responsibility": "æ¨¡å—èŒè´£",
        "sub_modules": [...],
        "all_files": [...],
        "key_files": [
          {{
            "path": "...",
            "imports": [...],
            "exports": [...],
            "language": "..."
          }}
        ]
      }}
    ]
  }},
  "dependency_graph": {{
    "nodes": [
      {{"id": "æ¨¡å—A", "label": "æ¨¡å—A", "layer": "core"}},
      {{"id": "æ¨¡å—B", "label": "æ¨¡å—B", "layer": "business"}}
    ],
    "edges": [
      {{"from": "æ¨¡å—B", "to": "æ¨¡å—A", "relationship": "ä¾èµ–"}}
    ],
    "mermaid": "graph TD\\n  B[æ¨¡å—B] --> A[æ¨¡å—A]"
  }},
  "file_module_mapping": {{
    "src/module/file1.js": "æ¨¡å—å"
  }},
  "analysis_metadata": {{
    "total_modules": æ•°å­—,
    "core_modules": ["..."],
    "business_modules": ["..."],
    "utils_modules": ["..."]
  }}
}}
```

**é‡è¦æç¤º**:
- è¾“å‡ºå¿…é¡»æ˜¯æœ‰æ•ˆçš„ JSON
- ä¸è¦åœ¨ JSON å‰åæ·»åŠ è¯´æ˜æ–‡å­—
"""

